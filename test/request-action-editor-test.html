<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../request-action-editor.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <request-action-editor></request-action-editor>
      </template>
    </test-fixture>

    <test-fixture id="opened">
      <template>
        <request-action-editor opened></request-action-editor>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, MockInteractions, sinon, TestHelpers */
    suite('basic', function() {
      const config = {
        source: 'response.headers.content-type',
        action: 'assign-variable',
        destination: 'someValue',
        enabled: true,
        conditions: [{
          source: 'response.status',
          operator: 'equal',
          condition: 200,
          enabled: true
        }]
      };
      var element;
      setup(function() {
        element = fixture('basic');
        element.action = Object.assign({}, config);
      });

      test('source is computed', function() {
        assert.equal(element.source, 'response');
      });

      test('sourceType is computed', function() {
        assert.equal(element.sourceType, 'headers');
      });

      test('sourcePath is computed', function() {
        assert.equal(element.sourcePath, 'content-type');
      });

      test('_cancelSourceProcessing is not set', function() {
        assert.isFalse(element._cancelSourceProcessing);
      });

      test('opened is false by default', function() {
        assert.isFalse(element.opened);
      });

      test('Updates condition.source', function() {
        element.source = 'request';
        element.sourceType = 'url';
        element.sourcePath = 'query';
        assert.equal(element.action.source, 'request.url.query');
      });

      test('source path input is visible', function() {
        var elm = element.$$('.source-path');
        var style = getComputedStyle(elm);
        assert.notEqual(style.display, 'none');
      });

      test('Hides source path input', function() {
        element.sourceType = 'status';
        var elm = element.$$('.source-path');
        var style = getComputedStyle(elm);
        assert.equal(style.display, 'none');
      });

      test('Enable button is not rendered', function() {
        TestHelpers.forceXIfStamp(element);
        var elm = element.$$('.action-enabler');
        assert.notOk(elm);
      });

      test('Info label is rendered', function() {
        TestHelpers.forceXIfStamp(element);
        var elm = element.$$('.short-info');
        assert.ok(elm);
      });

      test('Renders conditions', function() {
        TestHelpers.forceXIfStamp(element);
        var elm = element.$$('request-condition-editor');
        assert.ok(elm);
      });

      test('Adds condition on button click', function() {
        assert.lengthOf(element.action.conditions, 1);
        var button = element.$$('.add-condition');
        MockInteractions.tap(button);
        assert.lengthOf(element.action.conditions, 2);
      });
    });

    suite('_computeToglePanelLabel()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Label for opened', function() {
        const result = element._computeToglePanelLabel(true);
        assert.equal(result, 'Hide editor');
      });

      test('Label for not opened', function() {
        const result = element._computeToglePanelLabel(false);
        assert.equal(result, 'Show editor');
      });
    });

    suite('_computeActionStateLabel()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Label for enabled', function() {
        const result = element._computeActionStateLabel(true);
        assert.equal(result, 'enabled');
      });

      test('Label for not enabled', function() {
        const result = element._computeActionStateLabel(false);
        assert.equal(result, 'disabled');
      });
    });

    suite('_computePathHidden()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Returns true for status', function() {
        const result = element._computePathHidden('status');
        assert.isTrue(result);
      });

      test('Returns false for other types', function() {
        assert.isFalse(element._computePathHidden('url'));
        assert.isFalse(element._computePathHidden('headers'));
        assert.isFalse(element._computePathHidden('body'));
      });
    });

    suite('_computeActionLabel()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Return value for assign-variable', function() {
        const result = element._computeActionLabel('assign-variable');
        assert.equal(result, 'Assign variable');
      });

      test('Return value for other types', function() {
        assert.equal(element._computeActionLabel('store-variable'), 'Store variable');
      });
    });

    suite('addCondition()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Adds condition with default values', function() {
        element.addCondition();
        var c = element.action.conditions[0];
        assert.equal(c.source, 'response.status');
        assert.equal(c.operator, 'equal');
        assert.equal(c.condition, 200);
        assert.isTrue(c.enabled);
      });

      test('Adds condition with predefined values', function() {
        const data = {
          source: 'request.url',
          operator: 'contains',
          condition: 'test',
          enabled: false
        };
        element.addCondition(data);
        var c = element.action.conditions[0];
        assert.equal(c.source, data.source);
        assert.equal(c.operator, data.operator);
        assert.equal(c.condition, data.condition);
        assert.equal(c.enabled, data.enabled);
      });
    });

    suite('Delete action', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Dispatches remove-action-item custom event', function() {
        const spy = sinon.spy();
        element.addEventListener('remove-action-item', spy);
        var button = element.$$('.remove-action');
        MockInteractions.tap(button);
        assert.isTrue(spy.calledOnce);
      });

      test('remove-action-item custom event does not bubble', function(done) {
        element.addEventListener('remove-action-item', function clb(e) {
          element.removeEventListener('remove-action-item', clb);
          assert.isFalse(e.bubbles);
          done();
        });
        element.remove();
      });
    });

    suite('_removeCondition()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
        element.action = {
          source: 'response.headers.content-type',
          action: 'assign-variable',
          destination: 'someValue',
          enabled: true,
          conditions: [{
            source: 'response.status',
            operator: 'equal',
            condition: 200,
            enabled: true
          }]
        };
        TestHelpers.forceXIfStamp(element);
      });

      test('Removes condition from the list', function() {
        var editor = element.$$('request-condition-editor');
        editor.remove();
        assert.lengthOf(element.action.conditions, 0);
      });

      test('Removes element from the dom', function() {
        var editor = element.$$('request-condition-editor');
        editor.remove();
        TestHelpers.forceXIfStamp(element);
        editor = element.$$('request-condition-editor');
        assert.notOk(editor);
      });
    });

    suite('Opened', function() {
      var element;
      setup(function() {
        element = fixture('opened');
        element.action = {
          source: 'response.headers.content-type',
          action: 'assign-variable',
          destination: 'someValue',
          enabled: true
        };
        TestHelpers.forceXIfStamp(element);
      });

      test('Enable button is rendered', function() {
        TestHelpers.forceXIfStamp(element);
        var elm = element.$$('.action-enabler');
        assert.ok(elm);
      });

      test('Info label is not rendered', function() {
        TestHelpers.forceXIfStamp(element);
        var elm = element.$$('.short-info');
        var style = getComputedStyle(elm);
        assert.notEqual(style.display, 'none');
      });
    });
    </script>
  </body>
</html>
